<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>Gracefully exiting from console programs in Ruby | Future Simple Lab</title>
<link href='/css/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/style.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/post.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/coderay.css' media='screen' rel='stylesheet' type='text/css' />
<script src='/js/jquery.js' type='text/javascript'></script>
<script src='/js/welcome_code.js' type='text/javascript'></script>
<meta content='width=device-width, initial-scale=1.0' name='viewport' />
<meta content='http://futuresimple.github.com/images/logo-fs-short.png' property='og:image' />
<link href='/index.xml' rel='alternate' title='Future Simple Lab' type='application/atom+xml' />

</meta>
</head>
<body>
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29668048-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>

<div class='container bottom-space'>
<div id='header'>
<a href='/'>
<img alt='FS Logo' class='logo' src='/images/logo-fs.png' />
</a>
<ul class='nav nav-pills pull-right'>
<li>
<a href='/rss.xml'>Subscribe</a>
</li>
<li>
<a href='http://hackkrk.com/' target='_blank'>HackKRK</a>
</li>
<li>
<a href='http://www.futuresimple.com/company/careers/' target='_blank'>Jobs</a>
</li>
</ul>
<div class='clear'></div>
</div>

<div class='clear'></div>
<div class='row'>
<div class='span8'>
<h2 class='post-title'>Gracefully exiting from console programs in Ruby</h2>
<div class='post-meta'>
<div class='author'>Marcin Bunsch @ 2012-02-24</div>
<div class='facebook-share'>
<a name='fb_share'></a>
<script src='http://static.ak.fbcdn.net/connect.php/js/FB.Share' type='text/javascript'></script>
</div>
<div class='twitter-button'>
<a class='twitter-share-button' data-text='Gracefully exiting from console programs in Ruby' data-url='http://futuresimple.github.com/posts/2012-02-24-graceful-exiting-from-console-programs-in-ruby/' data-via='futuresimplelab' href='https://twitter.com/share'>Tweet</a>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
</div>
<div class='clear'></div>
<article>
<p>Imagine you write a CLI program or a Rake task which loops through some data performing some work on it. You run it and then you remembered something. You’d love to kill the process with ctrl-c, but that will raise an exception somewhere in the loop. What you want is for the iteration to complete and then you want the program to quit.</p>

<p>You could handle the <code>Interrupt</code> exception or add some conditions. But how about a cleaner and reusable way?</p>



<p>No problem - you can trap signals, which means we can trap the ctrl-c (which is an INT signal). Servers, like unicorn, use signals for graceful restarts.</p>

<p>How it works - you can use the <a href="http://www.ruby-doc.org/core-1.9.3/Kernel.html#method-i-trap">trap method</a> which accepts the name of the signal and a block to which replaces the system’s default handler.</p>

<pre><code class="language-ruby">trap <span class="string"><span class="delimiter">"</span><span class="content">INT</span><span class="delimiter">"</span></span> {
  <span class="comment"># You can do your own stuff here</span>
  <span class="comment">#</span>
  <span class="comment"># Remember, the signal dies here - if you don't</span>
  <span class="comment"># raise an exception or exit the process, nothing will happen</span>
}</code></pre>

<p>Here’s a simple example where I wrapped this pattern in a singleton class:</p>

<pre><code class="language-ruby">require <span class="string"><span class="delimiter">"</span><span class="content">singleton</span><span class="delimiter">"</span></span>

<span class="keyword">class</span> <span class="class">GracefulQuit</span>
  include <span class="constant">Singleton</span>

  attr_accessor <span class="symbol">:breaker</span>

  <span class="keyword">def</span> <span class="function">initialize</span>
    <span class="predefined-constant">self</span>.breaker = <span class="predefined-constant">false</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">enable</span>
    trap(<span class="string"><span class="delimiter">'</span><span class="content">INT</span><span class="delimiter">'</span></span>) {
      <span class="keyword">yield</span> <span class="keyword">if</span> block_given?
      <span class="predefined-constant">self</span>.instance.breaker = <span class="predefined-constant">true</span>
    }
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">check</span>(message = <span class="string"><span class="delimiter">"</span><span class="content">Quitting</span><span class="delimiter">"</span></span>)
    <span class="keyword">if</span> <span class="predefined-constant">self</span>.instance.breaker
      <span class="keyword">yield</span> <span class="keyword">if</span> block_given?
      puts message
      exit
    <span class="keyword">end</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></code></pre>

<p>So now how to use it? First, enable it before the loop using <code>GracefulQuit.enable</code> and then somewhere within the loop call <code>GracefulQuit.check</code>. Like in this example:</p>

<pre><code class="language-ruby"><span class="constant">GracefulQuit</span>.enable
some_collection.each <span class="keyword">do</span> |item|
  heavy_duty_work_on item
  <span class="constant">GracefulQuit</span>.check
<span class="keyword">end</span></code></pre>

<p>And that’s it - when you press ctrl-c, an exception will not be raised but the program will quit when you want it to. You can even add your own handler for this event.</p>

<pre><code class="language-ruby"><span class="constant">GracefulQuit</span>.enable
some_collection.each <span class="keyword">do</span> |item|
  heavy_duty_work_on item
  <span class="constant">GracefulQuit</span>.check <span class="keyword">do</span>
    cleanup
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>

<p>Of course, this doesn’t solve other problems, like picking up when you left off, but allows to have better control over console programs or Rake tasks.</p>
</article>
<div id='disqus_thread'></div>
<script type='text/javascript'>
var disqus_shortname = 'futuresimplelab'; // required: replace example with your forum shortname
var disqus_identifier = 'gracefully-exiting-from-console-programs-in-ruby';
var disqus_url = 'http://futuresimple.github.com/posts/2012-02-24-graceful-exiting-from-console-programs-in-ruby/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>
Please enable JavaScript to view the
<a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
blog comments powered by
<span class='logo-disqus'>Disqus</span>
</a>

</div>
<div class='span4'>
<script charset='utf-8' src='http://widgets.twimg.com/j/2/widget.js'></script>
<script type='text/javascript'>
  //<![CDATA[
    new TWTR.Widget({
      version: 2,
      type: 'profile',
      rpp: 6,
      interval: 30000,
      width: 'auto',
      height: 300,
      theme: {
        shell: {
          background: '#ffffff',
          color: '#666666'
        },
        tweets: {
          background: '#ffffff',
          color: '#666666',
          links: '#2A95B3'
        }
      },
      features: {
        scrollbar: false,
        loop: false,
        live: false,
        behavior: 'all'
      }
    }).render().setUser('futuresimplelab').start();
  //]]>
</script>

<div class='github'>
<div class='repos'>
<div class='logo'>
<img alt='Github' src='/images/github_logo.png' />
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
158
<img src='/images/icons/fork_11x12.png' />
6
</div>
<div class='name'>
<a href='https://github.com/futuresimple/broadcast'>
broadcast
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
A broadcasting microframework making publishing of messages to different services easy.
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
128
<img src='/images/icons/fork_11x12.png' />
10
</div>
<div class='name'>
<a href='https://github.com/futuresimple/dropbox-api'>
dropbox-api
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
Dropbox API Ruby Client
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
91
<img src='/images/icons/fork_11x12.png' />
14
</div>
<div class='name'>
<a href='https://github.com/futuresimple/jessie'>
jessie
</a>
</div>
<div class='language'>
JavaScript
</div>
<div class='description'>
Node runner for Jasmine JavaScript BDD testing framework
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
4
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/futuresimple.github.com'>
futuresimple.github.com
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
Future Simple's github homepage
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
2
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/api_client'>
api_client
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
HTTP API Client Builder
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
2
<img src='/images/icons/fork_11x12.png' />
0
</div>
<div class='name'>
<a href='https://github.com/futuresimple/obedience-core'>
obedience-core
</a>
</div>
<div class='language'>
JavaScript
</div>
<div class='description'>
Obedience Core
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/restart_butler'>
restart_butler
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>

</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/presentations'>
presentations
</a>
</div>
<div class='language'>

</div>
<div class='description'>
All kinds of presentations delivered by FS team members
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/blog-lab'>
blog-lab
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>

</div>
</div>
</div>
</div>

</div>
</div>
</div>
</body>
</html>
