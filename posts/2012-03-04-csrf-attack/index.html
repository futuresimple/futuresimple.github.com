<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en'>
<head>
<meta charset='utf-8'>
<title>CSRF Attack using JavaScript | Future Simple Lab</title>
<link href='/css/bootstrap.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/bootstrap-responsive.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/style.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/post.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/coderay.css' media='screen' rel='stylesheet' type='text/css' />
<script src='/js/jquery.js' type='text/javascript'></script>
<script src='/js/welcome_code.js' type='text/javascript'></script>
<meta content='width=device-width, initial-scale=1.0' name='viewport' />
<meta content='http://futuresimple.github.com/images/logo-fs-short.png' property='og:image' />
<link href='/index.xml' rel='alternate' title='Future Simple Lab' type='application/atom+xml' />

</meta>
</head>
<body>
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29668048-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>

<div class='container bottom-space'>
<div id='header'>
<a href='/'>
<img alt='FS Logo' class='logo' src='/images/logo-fs.png' />
</a>
<ul class='nav nav-pills pull-right'>
<li>
<a href='/rss.xml'>Subscribe</a>
</li>
<li>
<a href='http://hackkrk.com/' target='_blank'>HackKRK</a>
</li>
<li>
<a href='http://www.futuresimple.com/company/careers/' target='_blank'>Jobs</a>
</li>
</ul>
<div class='clear'></div>
</div>

<div class='clear'></div>
<div class='row'>
<div class='span8'>
<h2 class='post-title'>CSRF Attack using JavaScript</h2>
<div class='post-meta'>
<div class='author'>Bart Kiszala @ 2012-03-04</div>
<div class='facebook-share'>
<a name='fb_share'></a>
<script src='http://static.ak.fbcdn.net/connect.php/js/FB.Share' type='text/javascript'></script>
</div>
<div class='twitter-button'>
<a class='twitter-share-button' data-text='CSRF Attack using JavaScript' data-url='http://futuresimple.github.com/posts/2012-03-04-csrf-attack/' data-via='futuresimplelab' href='https://twitter.com/share'>Tweet</a>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
</div>
<div class='clear'></div>
<article>
<p>Most of you are aware of the <a href="http://pl.wikipedia.org/wiki/Cross-site_request_forgery">CSRF attack</a>. I use JS on a daily basis but I actually never thought that the code I develop could be CSRF-prone.</p>

<p>You saw that coming -  I was wrong and I want to share that harsh lesson.</p>

<p>Let’s assume you’re developing a web app called omg-app.com (obviously because it’s so good it will make everyone say OMG!). The app is getting bigger, lots of people use it, new features are being added on a weekly basis. At some point you conclude it would be nice to inform users about some recently added features.</p>



<p>How do you do that? The most common solution would be to display a banner for users who logged in describing the newly released stuff.</p>

<p>Banner can be saying sth like:</p>

<pre><code>Hello bart@futuresimple.com! Great news - new file upload has just been released!
</code></pre>

<p>However, the code that will embed the banner is coming from a separate application - the banner app. A great, asynchronous way is to make the omg-app embed a javascript file, so that the banner app can inject the banner into the page.</p>

<p>It’s simple and designed for failure. If it doesn’t load, nothing bad happens and it is easy to embed in other future applications.</p>

<p>The embed will look like this:</p>

<pre><code class="language-html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">text/javascript</span><span class="delimiter">"</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">/banner.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>

<p>Now, the banner app will respond to /banner.js with rendering of javascript code prepopulated with appropriate content, like this:</p>

<pre><code class="language-javascript"><span class="comment">// This is how banner.js.erb looks like inside</span>
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).append(<span class="string"><span class="delimiter">"</span><span class="content">&lt;div class='banner'/&gt;</span><span class="delimiter">"</span></span>);
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.banner</span><span class="delimiter">'</span></span>).html(<span class="string"><span class="delimiter">'</span><span class="content">Hello &lt;%= current_user.email %&gt;! Great news - new file upload has just been released!</span><span class="delimiter">'</span></span>);<span class="string"><span class="delimiter">"</span><span class="content"> }</span></span></code></pre>

<p>Now if a user is logged in and she hasn’t seen the new upload yet - the following script will be loaded to the page:
(I assume jQuery is available)</p>

<pre><code class="language-javascript"><span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).append(<span class="string"><span class="delimiter">"</span><span class="content">&lt;div class='banner'/&gt;</span><span class="delimiter">"</span></span>);
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.banner</span><span class="delimiter">'</span></span>).html(<span class="string"><span class="delimiter">'</span><span class="content">Hello bart@futuresimple.com! Great news - new file upload has just been released!</span><span class="delimiter">'</span></span>);</code></pre>

<p>Great! Problem solved, time to play some office ping-pong… Not so fast dude.</p>

<p>As it happens omg-app.com is super popular and many people are logged in at all times. Authentication information for omg-app is
being kept in browsers’ cookie. What is the problem?</p>

<p>Lets assume that my good pal Mike is logged in. At the same time he clicked on a link which leads to the site with funny cats
(what a lovely site it is …) in other tab of his browser.  Not only is the kitten site unbearably cute, it is also a malicious site which
loads exactly the same script as omg-app.com:</p>

<pre><code class="language-html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">text/javascript</span><span class="delimiter">"</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://omg-app.com/banner.js</span><span class="delimiter">"</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>

<p>Since Mike is logged in to omg-app and the authentication cookie is present - the kitten site gets the same response - meaning:</p>

<pre><code>"Hello bart@futuresimple.com - new file upload was just released".
</code></pre>

<p>Now all the attacker needs to do is read the content of the div with the class “banner”. Boom - email stolen.</p>

<p>How can it be fixed then?</p>

<p>My first idea was to verify if a script was loaded from omg-app.com domain on the server-side:</p>

<pre><code class="language-ruby"><span class="keyword">def</span> <span class="function">banner</span>
   <span class="keyword">return</span> <span class="string"><span class="delimiter">"</span><span class="delimiter">"</span></span> <span class="keyword">unless</span> request.referrer.match( <span class="regexp"><span class="delimiter">/</span><span class="content">^http:</span><span class="char">\/</span><span class="char">\/</span><span class="content">omg-app.com</span><span class="delimiter">/</span></span>)
   ...
<span class="keyword">end</span></code></pre>

<p>That solution isn’t really good for the following reasons:</p>

<ul>
<li>
    <p>in Rails specifically you can’t always get the request referrer of the page where script was loaded. This applies to requests coming from the script tag.</p>
  </li>
  <li>
    <p>if the user has a plugin which blocks the referrer from being sent, your app will never get the referrer url</p>
  </li>
</ul><p>How about adding a check to the code returned by the banner app to verify the location and only then embedding the html.</p>

<p>Seems like a great idea … Now the code responsible for the banner would look something like this:</p>

<pre><code class="language-javascript"><span class="predefined">$</span>(<span class="keyword">function</span>(){
 <span class="keyword">var</span> regex = <span class="regexp"><span class="delimiter">/</span><span class="content">\.</span><span class="content">omg-app</span><span class="content">\.</span><span class="content">com$</span><span class="delimiter">/</span></span>
  <span class="keyword">if</span> (regex.test(window.location.host)) {
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).append(<span class="string"><span class="delimiter">"</span><span class="content">&lt;div class='banner'/&gt;</span><span class="delimiter">"</span></span>);
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.banner</span><span class="delimiter">'</span></span>).html(<span class="string"><span class="delimiter">'</span><span class="content">Hello  bart@futuresimple.com!  Great news - new file upload has just been released!</span><span class="delimiter">'</span></span>);
  }
});</code></pre>

<p>We wrap the code in a function to make the regex a private variable.</p>

<p>Bad news - this is not safe at all.</p>

<p>Even if the malicious site would include the whole code above, RegExp.prototype.test method can be easily overwitten (welcome to JS world…) to always return true.</p>

<pre><code class="language-javascript">RegExp.prototype.<span class="function">test</span> = <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="predefined-constant">true</span> }</code></pre>

<p>With this tiny bit of code, the condition will be always true and we’re back to the initial problem.</p>

<p>Ok - so now I can pull out the big guns and include the banner information in iframe on each page. This starts to be really complicated and I’m not a big fan of iframes.</p>

<p>The solution I decided to go for is to load the banner after getting its content via an AJAX request.</p>

<p>My Rails action looks sth like:</p>

<pre><code class="language-ruby"><span class="keyword">class</span> <span class="class">BannerController</span> &lt; <span class="constant">ApplicationController</span>
  <span class="keyword">def</span> <span class="function">show</span>
    respond_to <span class="keyword">do</span> |format|
      <span class="keyword">if</span> current_user.saw_new_upload?
        format.json {
          render <span class="symbol">:json</span> =&gt; {<span class="symbol">:message</span> =&gt; <span class="string"><span class="delimiter">"</span><span class="content">Hello </span><span class="inline"><span class="inline-delimiter">#{</span>current_user.email<span class="inline-delimiter">}</span></span><span class="content"> - new file upload was just released</span><span class="delimiter">"</span></span>  } }
      <span class="keyword">else</span>
        format.json { render <span class="symbol">:json</span> =&gt; {} }
      <span class="keyword">end</span>
      <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>

<p>Now in omg-app, I simply implement a client to pick up this information.</p>

<pre><code class="language-javascript">(<span class="keyword">function</span>() {
  <span class="keyword">var</span> methods = {
    <span class="function">display_html</span>: <span class="keyword">function</span>(message) {
      <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">body</span><span class="delimiter">'</span></span>).append(<span class="predefined">$</span>(<span class="string"><span class="delimiter">"</span><span class="content">&lt;div class='banner'/&gt;</span><span class="delimiter">"</span></span>));
      <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">.banner</span><span class="delimiter">'</span></span>).append(message);
    }
  }
  <span class="predefined">$</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">/banner.json</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(data) {
    display_html(data.message)
  })
}());</code></pre>

<p>Why is this solution safe? (is it?!)
Because of <a href="http://en.wikipedia.org/wiki/Same_origin_policy">same origin policy</a>. In nutshell - only scripts (e.x. ajax requests) originating from the same site (omg-app.com) can access banner action in your web app.</p>

<p>That means that browser blocks any ajax requests originated on kitty site to access your application hence CSRF attack described earlier is not a problem any more.</p>

<p>So far so good. There surely are some pitfalls (e.g. subdomains) of this approach, but that’s the best one I came up with so far.
If you have any suggestions, share them in the comments!</p>
</article>
<div id='disqus_thread'></div>
<script type='text/javascript'>
var disqus_shortname = 'futuresimplelab'; // required: replace example with your forum shortname
var disqus_identifier = 'csrf-attack-using-javascript';
var disqus_url = 'http://futuresimple.github.com/posts/2012-03-04-csrf-attack/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>
Please enable JavaScript to view the
<a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
blog comments powered by
<span class='logo-disqus'>Disqus</span>
</a>

</div>
<div class='span4'>
<script charset='utf-8' src='http://widgets.twimg.com/j/2/widget.js'></script>
<script type='text/javascript'>
  //<![CDATA[
    new TWTR.Widget({
      version: 2,
      type: 'profile',
      rpp: 6,
      interval: 30000,
      width: 'auto',
      height: 300,
      theme: {
        shell: {
          background: '#ffffff',
          color: '#666666'
        },
        tweets: {
          background: '#ffffff',
          color: '#666666',
          links: '#2A95B3'
        }
      },
      features: {
        scrollbar: false,
        loop: false,
        live: false,
        behavior: 'all'
      }
    }).render().setUser('futuresimplelab').start();
  //]]>
</script>

<div class='github'>
<div class='repos'>
<div class='logo'>
<img alt='Github' src='/images/github_logo.png' />
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
158
<img src='/images/icons/fork_11x12.png' />
6
</div>
<div class='name'>
<a href='https://github.com/futuresimple/broadcast'>
broadcast
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
A broadcasting microframework making publishing of messages to different services easy.
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
128
<img src='/images/icons/fork_11x12.png' />
10
</div>
<div class='name'>
<a href='https://github.com/futuresimple/dropbox-api'>
dropbox-api
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
Dropbox API Ruby Client
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
91
<img src='/images/icons/fork_11x12.png' />
14
</div>
<div class='name'>
<a href='https://github.com/futuresimple/jessie'>
jessie
</a>
</div>
<div class='language'>
JavaScript
</div>
<div class='description'>
Node runner for Jasmine JavaScript BDD testing framework
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
4
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/futuresimple.github.com'>
futuresimple.github.com
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
Future Simple's github homepage
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
2
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/api_client'>
api_client
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>
HTTP API Client Builder
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
2
<img src='/images/icons/fork_11x12.png' />
0
</div>
<div class='name'>
<a href='https://github.com/futuresimple/obedience-core'>
obedience-core
</a>
</div>
<div class='language'>
JavaScript
</div>
<div class='description'>
Obedience Core
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/restart_butler'>
restart_butler
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>

</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/presentations'>
presentations
</a>
</div>
<div class='language'>

</div>
<div class='description'>
All kinds of presentations delivered by FS team members
</div>
</div>
<div class='repo'>
<div class='stats'>
<img src='/images/icons/eye_12x9.png' />
1
<img src='/images/icons/fork_11x12.png' />
1
</div>
<div class='name'>
<a href='https://github.com/futuresimple/blog-lab'>
blog-lab
</a>
</div>
<div class='language'>
Ruby
</div>
<div class='description'>

</div>
</div>
</div>
</div>

</div>
</div>
</div>
</body>
</html>
